<div class="container-fluid py-2">
    <div class="row">
        <div class="col-12">
            <div class="card my-4">
                <div
                    class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
                    <div
                        class="bg-gradient-dark shadow-dark border-radius-lg pt-4 pb-3">
                        <h6 class="text-white text-capitalize ps-1 m-2">بررسی
                            ورود و خروج ها</h6>
                    </div>
                </div>
                <div class="card-body px-0 pb-2">
                    <form class="form row container-fluid" id="logerForm">
                        <h6>جستجو</h6>

                        <div class="col input-group input-group-outline my-3">
                            <label
                                class="form-label text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                نام کاربر را وارد کنید
                            </label>
                            <input type="text" id="logUsername"
                                class="form-control" placeholder required>
                        </div>
                        <div class="col input-group input-group-outline my-3">
                            <label
                                class="form-label text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                سال را وارد کنید
                            </label>
                            <input type="number" id="logYear"
                                class="form-control" placeholder>
                        </div>
                        <div class="col input-group input-group-outline my-3">
                            <label
                                class="form-label text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                ماه را وارد کنید
                            </label>
                            <input type="number" id="logMonth"
                                class="form-control" placeholder min="1"
                                max="12">
                        </div>
                        <div class="col input-group input-group-outline my-3">
                            <label
                                class="form-label text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                روز را وارد کنید
                            </label>
                            <input type="number" id="logDay"
                                class="form-control" placeholder min="1"
                                max="31">
                        </div>

                        <div class="col input-group input-group-outline my-3">
                            <input type="submit" value="جستجو"
                                class="btn bg-gradient-dark w-100 mb-2">
                        </div>
                    </form>
                    <div class="table-responsive p-0">
                        <!-- <table class="table align-items-center mb-0"
                            id="table-loger">
                            <thead>
                                <tr id="table-loger-tr">

                                </thead>
                                <tbody id="table-loger-tbody">
                                </tbody>
                            </table>
                            <div class="container-fluid p-2"
                                style="text-align: center;"
                                id="table-loger-pagination"></div> -->
                        <canvas id="logChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer class="footer py-4  ">
        <div class="container-fluid">
            <div
                class="row align-items-center justify-content-lg-between">
                <div class="col-lg-6 mb-lg-0 mb-4">
                    <div
                        class="copyright text-center text-sm text-muted text-lg-end">
                        © <script>
                  document.write(new Date().getFullYear())
                </script>,
                        ساخته شده <i class="fa fa-heart"></i> توسط
                        <a href="https://www.github.com/amili-code"
                            class="font-weight-bold"
                            target="_blank">amili-code</a>
                        برای مدیریت اسان تر
                    </div>
                </div>
                <div class="col-lg-6">
                    <ul
                        class="nav nav-footer justify-content-center justify-content-lg-end">
                        <li class="nav-item">
                            <a href="https://www.creative-tim.com"
                                class="nav-link text-muted"
                                target="_blank">درباره ما</a>
                        </li>
                        <li class="nav-item">
                            <a
                                href="https://www.creative-tim.com/presentation"
                                class="nav-link text-muted"
                                target="_blank">درباره نرم افزار</a>
                        </li>
                        <li class="nav-item">
                            <a href="https://www.creative-tim.com/blog"
                                class="nav-link text-muted"
                                target="_blank">یادگیری</a>
                        </li>
                        <li class="nav-item">
                            <a href="https://amili-code.github.io"
                                class="nav-link pe-0 text-muted"
                                target="_blank">من</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>
</div>

<script>
let chartInstance = null;

     document.getElementById("logerForm").addEventListener("submit", async function(event) {
            event.preventDefault();
            const userName = document.getElementById("logUsername").value;
            const year = document.getElementById("logYear").value;
            const month = document.getElementById("logMonth").value;
            const day = document.getElementById("logDay").value;
            
            const queryParams = new URLSearchParams({ userName });
            if (year) queryParams.append("year", year);
            if (month) queryParams.append("month", month);
            if (day) queryParams.append("day", day);
            
            const data = await apiRequest(`/loger?${queryParams.toString()}`);
            // const data = await response.json();
            renderChart(data, year, month, day);
        });

        
       function renderChart(data) {
        const ctx = document.getElementById("logChart").getContext("2d");
        if (window.myChart) {
            window.myChart.destroy();
        }

        let labels = [];
        let downloads = [];
        let uploads = [];

        console.log(data);

        for (const year in data) {
            if (Object.keys(data[year]).length === 1 && "uptime" in data[year]) {
                // حالتی که فقط سال انتخاب شده
                labels.push(year);
                downloads.push(parseInt(data[year].download) || 0);
                uploads.push(parseInt(data[year].upload) || 0);
            } else {
                for (const month in data[year]) {
                    if (month === "uptime") continue;
                    if (Object.keys(data[year][month]).length === 1 && "uptime" in data[year][month]) {
                        // حالتی که فقط ماه انتخاب شده
                        labels.push(`${year}/${month}`);
                        downloads.push(parseInt(data[year][month].download) || 0);
                        uploads.push(parseInt(data[year][month].upload) || 0);
                    } else {
                        for (const day in data[year][month]) {
                            if (day === "uptime") continue;
                            if (Array.isArray(data[year][month][day])) {
                                // حالتی که روز انتخاب شده است
                                data[year][month][day].forEach(entry => {
                                    labels.push(`${year}/${month}/${day} ${entry.time}`);
                                    downloads.push(parseInt(entry.download) || 0);
                                    uploads.push(parseInt(entry.upload) || 0);
                                });
                            } else {
                                // حالت نمایش داده‌های روزانه بدون تایم
                                labels.push(`${year}/${month}/${day}`);
                                downloads.push(parseInt(data[year][month][day].download) || 0);
                                uploads.push(parseInt(data[year][month][day].upload) || 0);
                            }
                        }
                    }
                }
            }
        }

        window.myChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [
                    {
                        label: "دانلود (MB)",
                        backgroundColor: "blue",
                        data: downloads
                    },
                    {
                        label: "آپلود (MB)",
                        backgroundColor: "red",
                        data: uploads
                    }
                ]
            }
        });
    }






</script>